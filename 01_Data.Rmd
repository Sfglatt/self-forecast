---
title: "01_Data"
author: "Sglatt"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r packages}
if (!require("dplyr")) {
  install.packages("dplyr")
  require("dplyr")
}
if (!require("psych")) {
  install.packages("psych")
  require("psych")
}
if (!require("readxl")) {
  install.packages("readxl")
  require("readxl")
}
if (!require("stringr")) {
  install.packages("stringr")
  require("stringr")
}
if (!require("tidyverse")) {
  install.packages("tidyverse")
  require("tidyverse")
}
```

# Folder for the output
```{r eval=FALSE}
if (!dir.exists("01_Output")) {
  dir.create("01_Output")
}
```

# First, the master database with suicide attempts over the year
```{r master data}
# Raw data in separate tabs
path <- "~/Labs/Github/project-life-force/project-life-force/Raw_datasets/database_12-29-2024.xlsx"
excel_sheets(path)

# This tab has suicide attempt data
events <- read_excel(path, sheet = "events")

# This tab has more attempt info
statusdat <- read_excel(path, sheet = "status")

events$dtdied <- statusdat$dtdied[match(events$id, statusdat$id)]
```

# Baseline C-SSRS data (lifetime and recent)
```{r cssrs data}
# Import C-SSRS data
cssrs_labels <- read.csv("~/Labs/Github/project-life-force/project-life-force/Raw_datasets/CSSRS_Baseline_Recent_Labels.csv")
cssrs_raw <- read.csv("~/Labs/Github/project-life-force/project-life-force/Raw_datasets/CSSRS_Baseline_Recent_Raw.csv")

# Fix the IDs
cssrs_raw <- cssrs_raw %>%
  mutate(subject_id = case_when(
    str_detect(subject_id, "^(?i)pp\\d+") ~ str_replace(subject_id, "^(?i)pp(\\d+)", "PH-\\1"),
    str_detect(subject_id, "^(?i)pt1\\d+") ~ str_replace(subject_id, "^(?i)pt1(\\d+)", "TX-\\1"),
    str_detect(subject_id, "^(?i)pt\\d+") ~ str_replace(subject_id, "^(?i)pt(\\d+)", "TX-\\1"),
    str_detect(subject_id, "^(?i)pn\\d+") ~ str_replace(subject_id, "^(?i)pn(\\d+)", "NP-\\1"),
    str_detect(subject_id, "^(?i)p\\d+") ~ str_replace(subject_id, "^(?i)p(\\d+)", "BX-\\1"),
    TRUE ~ subject_id
  )) %>%
  rename(id = subject_id) # and rename the column

# Check how many IDs overlap with the ids in the events sheet (all, 207)
length(intersect(cssrs_raw$id, events$id))

# Filter the C-SSRS data to only IDs that are in events
cssrs_raw_filtered <- cssrs_raw %>%
  filter(id %in% events$id)

# Now, to make a recent and lifetime suicide attempt variables:
# 0 = No, 1 = yes.

# "cssrs_actattrec_bl" = Actual Attempt (Recent)
# "cssrs_intattrec_bl" = Interrupted Attempt (Recent)
# "cssrs_abtattrec_bl" = Aborted or Self-Interrupted Attempt (Recent)
# "cssrs_preprec_bl" = Preparatory Acts or Behavior (Recent)

# "cssrs_actattlt_bl" = Actual Attempt (Lifetime)
# "cssrs_intattlt_bl" = Interrupted Attempt (Lifetime)
# "cssrs_abtattlt_bl" = Aborted or Self-Interrupted Attempt (Lifetime)
# "cssrs_preplt_bl" = Preparatory Acts or Behavior (Recent)

# cssrs_sbrec_bl = "Was Suicidal Behavior present during the past year? (Recent)
# Note: Code yes if the subject answered yes to any of the behaviors in this section EXCEPT Non-suicidal Self-Injurious Behavior."

# "cssrs_sblt_bl" = "Was Suicidal Behavior present during the participant's lifetime?
# Note: Code yes if the subject answered yes to any of the behaviors in this section EXCEPT Non-suicidal Self-Injurious Behavior."

# Make "recent" and "lifetime" attempt variables from aborted, interrupted, and actual behaviors
# If they have ANY of them == 1
# If they have NONE of them == 0
# If they have a combination of NONE and MISSING == NA
cssrs_raw_filtered <- cssrs_raw_filtered %>%
  mutate(
    attempt_recent = case_when(
      rowSums(across(c(
        cssrs_actattrec_bl,
        cssrs_intattrec_bl,
        cssrs_abtattrec_bl
      ), ~ . == 1), na.rm = TRUE) > 0 ~ 1,
      rowSums(across(c(
        cssrs_actattrec_bl,
        cssrs_intattrec_bl,
        cssrs_abtattrec_bl
      ), ~ . == 0), na.rm = FALSE) == 3 ~ 0,
      TRUE ~ NA_real_
    ),
    attempt_lifetime = case_when(
      rowSums(across(c(
        cssrs_actattlt_bl,
        cssrs_intattlt_bl,
        cssrs_abtattlt_bl
      ), ~ . == 1), na.rm = TRUE) > 0 ~ 1,
      rowSums(across(c(
        cssrs_actattlt_bl,
        cssrs_intattlt_bl,
        cssrs_abtattlt_bl
      ), ~ . == 0), na.rm = FALSE) == 3 ~ 0,
      TRUE ~ NA_real_
    )
  )

# For number of lifetime behaviors,
# cssrs_accattnumlt_bl = number of lifetime actual attempts
# cssrs_intattnumlt_bl = number of lifetime interrupted attempts
# cssrs_abtattnumlt_bl = number of lifetime aborted attempts

# Sum them for a 'total number of lifetime behaviors' variable
cssrs_raw_filtered <- cssrs_raw_filtered %>%
  mutate(total_behaviors_lifetime = rowSums(
    dplyr::select(
      .,
      cssrs_accattnumlt_bl,
      cssrs_intattnumlt_bl,
      cssrs_abtattnumlt_bl
    ) %>% mutate(across(everything(), as.numeric)),
    na.rm = TRUE
  )) %>%
  mutate(total_behaviors_lifetime = ifelse(
    is.na(cssrs_accattnumlt_bl) & is.na(cssrs_intattnumlt_bl) & is.na(cssrs_abtattnumlt_bl),
    NA,
    total_behaviors_lifetime
  ))

table(cssrs_raw_filtered$total_behaviors_lifetime)

# Add the cssrs attempt items to events
events <- events %>%
  left_join(
    cssrs_raw_filtered %>%
      select(
        id,
        cssrs_actattrec_bl, cssrs_intattrec_bl, cssrs_abtattrec_bl,
        cssrs_actattlt_bl, cssrs_intattlt_bl, cssrs_abtattlt_bl,
        attempt_recent, attempt_lifetime, cssrs_sblt_bl,
        cssrs_accattnumlt_bl, cssrs_intattnumlt_bl, cssrs_abtattnumlt_bl, total_behaviors_lifetime
      ),
    by = "id"
  )

events %>%
  select(
    cssrs_actattlt_bl,
    cssrs_intattlt_bl,
    cssrs_abtattlt_bl,
    attempt_lifetime,
    cssrs_sblt_bl
  )
```

# Baseline report
```{r events}
# Self-report data for all participants at all waves
plf_data <- read.csv("~/Labs/Github/project-life-force/project-life-force/01_Created_datasets/Merged_plf_data_filtered_2025-04-09.csv")

# Add baseline self-report variables to the suicide attempt data (events)

# First, filter the PLF data to just baseline
plf_data_baseline <- plf_data %>%
  filter(
    month == 0
  )

# Make a new BHS sum score for validity
bhs_items <- plf_data_baseline %>% select(ends_with("_bhs")) # Select all BHS items
plf_data_baseline$bhs_new <- rowSums(bhs_items, na.rm = FALSE) # Sum all BHS items

# Make sure that the new sum score is the same as the original
summary(plf_data_baseline$bhs)
summary(plf_data_baseline$bhs_new)


# Make BHS subscales from negative expectation items and positive expectation items

# Currently, the positive expectation items are reverse scored so that endorsing a positive expectation  = 0
# Reverse these back to the original scoring so that endorsing the positive expectation = 1
# Then sum the new posiitive expectation items for a total score
plf_data_baseline <- plf_data_baseline %>%
  mutate(
    q01_bhs_r = 1 - q01_bhs,
    q03_bhs_r = 1 - q03_bhs,
    q05_bhs_r = 1 - q05_bhs,
    q06_bhs_r = 1 - q06_bhs,
    q08_bhs_r = 1 - q08_bhs,
    q10_bhs_r = 1 - q10_bhs,
    q13_bhs_r = 1 - q13_bhs,
    q15_bhs_r = 1 - q15_bhs,
    q19_bhs_r = 1 - q19_bhs
  ) %>%
  mutate(
    bhs_pos = rowSums(select(
      ., q01_bhs_r, q03_bhs_r, q05_bhs_r, q06_bhs_r,
      q08_bhs_r, q10_bhs_r, q13_bhs_r, q15_bhs_r, q19_bhs_r
    ), na.rm = FALSE)
  ) %>%
  mutate(
    bhs_pos_n = rowSums(select(
      ., q01_bhs, q03_bhs, q05_bhs, q06_bhs,
      q08_bhs, q10_bhs, q13_bhs, q15_bhs, q19_bhs
    ), na.rm = FALSE)
  )

# Verify the reverse scoring
table(plf_data_baseline$q01_bhs)
table(plf_data_baseline$q01_bhs_r) # Good

table(plf_data_baseline$bhs_pos_n)
table(plf_data_baseline$bhs_pos) # Good

# Make the negative expectation subscale
plf_data_baseline <- plf_data_baseline %>%
  mutate(
    bhs_neg = rowSums(across(
      c(
        q02_bhs, q04_bhs, q07_bhs, q09_bhs, q11_bhs, q12_bhs,
        q14_bhs, q16_bhs, q17_bhs, q18_bhs, q20_bhs
      ),
      ~ as.numeric(.)
    ), na.rm = FALSE)
  )

# Merge the datasets
events <- left_join(events, plf_data_baseline, by = "id")
```

# Filter the dataset for analysis
```{r filter}
# Filter to those who have Beck Scale for Suicidal Ideation item 15 (expectation of a future suicide attempt)
events_filtered <- events %>%
  filter(!is.na(q15_ssi))

# Filter to people who aren't missing the C-SSRS
events_filtered <- events_filtered %>%
  dplyr::filter(!is.na(cssrs_actattlt_bl))
```

# Make new variables for analysis
```{r new vars}
# Item 15 (Expectation for suicide)
# Collapse 0 (no) and 1 (unsure) vs. 2 (sure)
events_filtered$q15_ssi_2 <- ifelse(events_filtered$q15_ssi == 2, 1, 0)

table(events_filtered$q15_ssi_2)
table(events_filtered$q15_ssi)

# Item 16 (preparation for suicide)
# 0 (no preparation) vs. 1 (some preparation) and 2 (almost finished or completed preparation) collapsed
events_filtered$q16_ssi_2 <- ifelse(events_filtered$q16_ssi %in% c(1, 2), 1,
  ifelse(is.na(events_filtered$q16_ssi), NA, 0)
)

# Item 13 (perceived access to method/opportunity for suicide)
# No method + method/no opportunity vs. method and opportunity
events_filtered$q13_ssi_2 <- ifelse(events_filtered$q13_ssi == 2, 1,
  ifelse(is.na(events_filtered$q13_ssi), NA, 0)
)
```

# Death data
```{r death data}
# Look at deaths
events_filtered %>%
  filter(!is.na(dtdied))

# [2025-10-03 Update after reviewing charts - 133 did not die (mistake on the PH site charts)]
# 019 is death by suicide
# 116 is not a death by suicide [accidental cocaine overdose or fatal cardiac arrhythmia provoked by drug]
# 147 is a death by suicide
# 152 died from COVID-19

# Remove death code and date of death from 133

events_filtered <- events_filtered %>%
  mutate(
    died = if_else(id == "PH-133", NA_integer_, died),
    dtdied = if_else(id == "PH-133", NA_Date_, dtdied)
  )

# Confirm change
events_filtered %>%
  filter(!is.na(dtdied))
```

# Truncate time-to-event to one year
```{r truncate time}
# Does anyone go past 365 days?
sum(events_filtered$surv > 365, na.rm = TRUE)

# Are any of the first attempts >365 days?
sum(events_filtered$att1 == 1 & events_filtered$surv > 365, na.rm = TRUE)

# Look at IDs of attempt #1 >365 days
events_filtered %>%
  filter(att1 == 1 & surv > 365) %>%
  pull(id) 

# Truncate time to 365 days
# For the the one person that had their first attempt >365 days, change their attempt code from 1 to 0
events_filtered <- events_filtered %>%
  mutate(
    surv_365 = pmin(surv, 365), # Truncate follow-up at 365 days
    att1_365 = ifelse(att1 == 1 & surv <= 365, 1, 0) # Only mark as event if it occurred within 365 days
  )

table(events_filtered$surv_365)

# surv_365 is the new variable for survival analysis, truncated at 365 days
# att1_365 is the new attempt variable, truncated at 365 days

# Verify that the 1 person goes from attempt -> no attempt
table(events_filtered$att1)
table(events_filtered$att1_365)

# Since this truncates at 365, the total number of attempts also needs to be checked (att1_365, att2, att3...)

# Truncate all attempts to 365 days
events_filtered <- events_filtered %>%
  mutate(
    att2_365 = ifelse(att2 == 1 & day2 <= 365, 1, 0),
    att3_365 = ifelse(att3 == 1 & day3 <= 365, 1, 0),
    att4_365 = ifelse(att4 == 1 & day4 <= 365, 1, 0),
    att5_365 = ifelse(att5 == 1 & day5 <= 365, 1, 0),
    att6_365 = ifelse(att6 == 1 & day6 <= 365, 1, 0),
    att7_365 = ifelse(att7 == 1 & day7 <= 365, 1, 0),
    att8_365 = ifelse(att8 == 1 & day8 <= 365, 1, 0)
  )

# Make a new total number of attempts variable
events_filtered <- events_filtered %>%
  mutate(
    natts_365 =
      att1_365
      + att2_365
        + att3_365
        + att4_365
        + att5_365
        + att6_365
        + att7_365
        + att8_365
  )

# Check the new numbers
table(events_filtered$natts)
table(events_filtered$natts_365) # One recurrent attempt was lost (and one emergent)

# Make a dichotomous variable for number of attempts; >1 = 1 and 1 and under = 0
events_filtered$natts_di <- ifelse(events_filtered$natts_365 > 1, 1, 0)
table(events_filtered$natts_di)

# Make a dichotomous variable for 1 vs >1 attempts
events_filtered$natts_di_2 <- ifelse(is.na(events_filtered$natts_365), NA,
  ifelse(events_filtered$natts_365 == 0, NA,
    ifelse(events_filtered$natts_365 == 1, 0, 1)
  )
)

# Who had less than 365 days of tracking (that did not die)
events_filtered %>%
  filter(surv < 365, att1_365 == 0, is.na(events_filtered$dtdied))

table(events_filtered$surv[events_filtered$surv_365 < 365 &
                               events_filtered$att1_365 == 0 &
                               is.na(events_filtered$dtdied)]) # 19

summary(events_filtered$surv[events_filtered$surv_365 < 365 &
                               events_filtered$att1_365 == 0 &
                               is.na(events_filtered$dtdied)]) 

table(events_filtered$surv[events_filtered$surv_365 < 340 &
                          events_filtered$att1_365 == 0 & 
                          is.na(events_filtered$dtdied)]) # 3

# Look at data for people < 340 days with no attempt and who did not die
events_filtered %>%
  filter(surv_365 < 340,
         att1_365 == 0,
         is.na(dtdied)) %>%
  select(id, att1_365, surv_365, q15_ssi, q15_ssi_2)

table(events_filtered$q15_ssi_2)
```

# Make dataframes with participant death(s) removed
```{r dth dataframe}
# Remove people who died with no suicide attempt over the study
events_filtered_1 <- events_filtered %>%
  filter(!( !is.na(dtdied) & att1_365 == 0 ))
events_filtered_1

# Who was removed?
events_filtered %>%
  filter(!is.na(dtdied) & att1_365 == 0)

# Remove people who died with and without a suicide attempt over the study
events_filtered_2 <- events_filtered %>%
  filter(!( !is.na(dtdied)))

events_filtered %>%
  filter(!is.na(dtdied))
```

# Make dataframes with participants < 340 days + no suicide attempt removed
```{r days missing dataframes}
# Remove participants who had less then 340 days available and no suicide attempt over the study + those who died without a suicide attempt
events_filtered_3 <- events_filtered_1 %>% # events_filtered_1 = people who died with no SA are already removed
  filter(!(surv_365 < 340 & att1_365 == 0)) # 3 more participants

# Who was removed?
events_filtered_1 %>%
  filter((surv_365 < 340 & att1_365 == 0)) 

# Remove participants who had less then 365 days available and no suicide attempt over the study + those who died without a suicide attempt
events_filtered_4 <- events_filtered_1 %>% # events_filtered_1 = people who died with no SA are already removed
  filter(!(surv_365 < 365 & att1_365 == 0)) # 3 more participants

# Who was removed?
events_filtered_1 %>%
  filter((surv_365 < 365 & att1_365 == 0)) 
```

# Save the dataset
```{r save, eval=FALSE}
write.csv(
  events_filtered,
  paste0("01_Output/Events_data_SG_", Sys.Date(), ".csv")
)
# 2025-06-15: First dataset
# 2025-08-06: Add the whole plf baseline dataset
# 2025-08-07: ...& add the whole CSSRS baseline dataset
# 2025-08-24: Filter to those who had a lifetime suicide behavior
# 2025-10-05: Correct mistaken chart data
```

# Scale reliability
```{r scale rel}
# Perceived suicide-related coping
srcs_items <- events_filtered %>%
  select(matches("^q\\d{2}_srcs$")) %>%
  select(-matches("^q(02|07|15|21)_srcs$"))

ltm::cronbach.alpha(srcs_items,
  CI = TRUE,
  na.rm = TRUE
)

# Beck Hopelessness Scale
## Total
bhs_items <- events_filtered %>%
  select(matches("^q\\d{2}_bhs$"))

ltm::cronbach.alpha(bhs_items,
  CI = TRUE,
  na.rm = TRUE
)

# negative expectations
ltm::cronbach.alpha(
  events_filtered[, c(
    "q02_bhs", "q04_bhs", "q07_bhs",
    "q09_bhs", "q11_bhs", "q12_bhs",
    "q14_bhs", "q16_bhs", "q17_bhs",
    "q18_bhs", "q20_bhs"
  )],
  CI = TRUE,
  na.rm = TRUE
)

# Positive expectations
ltm::cronbach.alpha(
  events_filtered[, c(
    "q01_bhs_r", "q03_bhs_r", "q05_bhs_r",
    "q06_bhs_r", "q08_bhs_r", "q10_bhs_r",
    "q13_bhs_r", "q15_bhs_r", "q19_bhs_r"
  )],
  CI = TRUE,
  na.rm = TRUE
)
```

