---
title: "02_Analysis"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}
if (!require("survival")) {
  install.packages("survival")
  require("survival")
}
if (!require("survminer")) {
  install.packages("survminer")
  require("survminer")
}
if (!require("ggfortify")) {
  install.packages("ggfortify")
  require("ggfortify")
}
if (!require("dplyr")) {
  install.packages("dplyr")
  require("dplyr")
}
if (!require("psych")) {
  install.packages("psych")
  require("psych")
}
if (!require("extrafont")) {
  install.packages("extrafont")
  require("extrafont")
}
# font_import(prompt = FALSE)
# loadfonts(device = "win")
# fonts()
```

# Import the dataset created in 01_Data
```{r data and dir, eval=FALSE}
events_filtered <- read.csv("01_Output/Events_data_SG_2025-10-05.csv")

# Folder to save the output
# dir.create("02_Output")
```

# Suicide descriptives for the sample
```{r describe}
# How many people had actual lifetime attempts?
events_filtered %>%
  count(cssrs_actattlt_bl, name = "Count", sort = FALSE) %>%
  mutate(Percent = round(100 * Count / sum(Count), 1))

# How many people had lifetime actual, aborted, and/or interrupted attempts?
events_filtered %>%
  count(attempt_lifetime, name = "Count", sort = FALSE) %>%
  mutate(Percent = round(100 * Count / sum(Count), 1))

# How many people had recent actual, aborted, and/or interrupted attempts?
events_filtered %>%
  count(attempt_recent, name = "Count", sort = FALSE) %>%
  mutate(Percent = round(100 * Count / sum(Count), 1))

# What was the range of lifetime actual, aborted, and interrupted behaviors (total across all of them)?
events_filtered %>%
  count(total_behaviors_lifetime, name = "Count", sort = FALSE) %>%
  mutate(Percent = round(100 * Count / sum(Count), 1))

# How much baseline ideation did people have?
events_filtered %>%
  count(q06_ssi, name = "Count", sort = FALSE) %>%
  mutate(Percent = round(100 * Count / sum(Count), 1))

# How many people perceived having access to a method and opportunity for suicide?
events_filtered %>%
  count(q13_ssi, name = "Count", sort = FALSE) %>%
  mutate(Percent = round(100 * Count / sum(Count), 1))

# How many people prepared for suicide?
events_filtered %>%
  count(q16_ssi, name = "Count", sort = FALSE) %>%
  mutate(Percent = round(100 * Count / sum(Count), 1))

# How many people had an attempt over the study period?
## For this statistic, remove people who died with no emergent suicide attempt
## & people with < 340 days and no emergent suicide attempt
events_filtered_3 %>%
  count(att1_365, name = "Count", sort = FALSE) %>%
  mutate(Percent = round(100 * Count / sum(Count), 1))

table(events_filtered$att1_365)
table(events_filtered$natts_365 > 0)

# How many people had more than 1 attempt over the study period?
## For this statistic, remove people who died with no emergent suicide attempt
## & people who died with an emergent suicide attempt(s)
events_filtered_2 %>%
  count(natts_365 > 1, name = "Count", sort = FALSE) %>%
  mutate(Percent = round(100 * Count / sum(Count), 1))

# What was the range of recurrence?
table(events_filtered$natts_365)

# How many people expected a future suicide attempt?
events_filtered %>%
  count(q15_ssi, name = "Count", sort = FALSE) %>%
  mutate(Percent = round(100 * Count / sum(Count), 1))

# How many people who expected a future suicide attempt had an emergent attempt over the study?
## Remove people who died with no emergent suicide attempt
## & people with < 340 days and no emergent suicide attempt
events_filtered_3 %>%
  count(q15_ssi, att1_365) %>%
  group_by(q15_ssi) %>%
  mutate(
    Percent = round(100 * n / sum(n), 1)
  ) %>%
  ungroup()

# Of the people who had concrete expectations about a suicide attempt in the future (i.e., removing "unsure"), how many were *accurate*?

# Make an accuracy variable
events_filtered_3 <- events_filtered_3 %>%
  mutate(accuracy = case_when(
    q15_ssi == 0 & att1_365 == 0 ~ 1, # 1 if people expect not to make a suicide attempt and did not have one
    q15_ssi == 0 & att1_365 == 1 ~ 0, # 0 if people expect not to make a suicide attempt and did have one
    q15_ssi == 2 & att1_365 == 1 ~ 1, # 1 if people expect to make a suicide attempt and did have one
    q15_ssi == 2 & att1_365 == 0 ~ 0, # 0 if people expect to make a suicide attempt and did not have one
    TRUE ~ NA_real_
  ))

events_filtered_3[events_filtered_3$q15_ssi != 1, ] %>%
  count(q15_ssi_2, att1_365) %>%
  group_by(q15_ssi_2) %>%
  mutate(
    Percent = round(100 * n / sum(n), 1)
  ) %>%
  ungroup()

# Excluding everyone < 365 days
# Make an accuracy variable
events_filtered_4 <- events_filtered_4 %>%
  mutate(accuracy = case_when(
    q15_ssi == 0 & att1_365 == 0 ~ 1, # 1 if people expect not to make a suicide attempt and did not have one
    q15_ssi == 0 & att1_365 == 1 ~ 0, # 0 if people expect not to make a suicide attempt and did have one
    q15_ssi == 2 & att1_365 == 1 ~ 1, # 1 if people expect to make a suicide attempt and did have one
    q15_ssi == 2 & att1_365 == 0 ~ 0, # 0 if people expect to make a suicide attempt and did not have one
    TRUE ~ NA_real_
  ))

events_filtered_4[events_filtered_4$q15_ssi != 1, ] %>%
  count(q15_ssi_2, att1_365) %>%
  group_by(q15_ssi_2) %>%
  mutate(
    Percent = round(100 * n / sum(n), 1)
  ) %>%
  ungroup()
```

# Time to event descriptives
```{r time to event}
# What was the mean time to first attempt?

## Remove people who died with no emergent suicide attempt
## & remove people with < 340 days and no emergent suicide attempt
summary(events_filtered_3[events_filtered_3$att1_365 == 1, ]$surv_365)
sd(events_filtered_3[events_filtered_3$att1_365 == 1, ]$surv_365)
table(events_filtered_3[events_filtered_3$att1_365 == 1, ]$surv_365)
nrow(events_filtered_3[events_filtered_3$att1_365 == 1, ])

# What was the mean time to first attempt when self-rated expectation == yes?
summary(events_filtered_3[events_filtered_3$att1_365 == 1 & events_filtered_3$q15_ssi_2 == 1, ]$surv_365)
sd(events_filtered_3[events_filtered_3$att1_365 == 1 & events_filtered_3$q15_ssi_2 == 1, ]$surv_365)
nrow(events_filtered_3[events_filtered_3$att1_365 == 1 & events_filtered_3$q15_ssi_2 == 1, ])

# What was the mean time to first attempt when self-rated expectation == no/unsure?
summary(events_filtered_3[events_filtered_3$att1_365 == 1 & events_filtered_3$q15_ssi_2 == 0, ]$surv_365)
sd(events_filtered_3[events_filtered_3$att1_365 == 1 & events_filtered_3$q15_ssi_2 == 0, ]$surv_365)
nrow(events_filtered_3[events_filtered_3$att1_365 == 1 & events_filtered_3$q15_ssi_2 == 0, ])
```

# Identify covariates with tests between emergent suicide attempt (absence vs. presence)
```{r cov}
# Remove people who died with no emergent suicide attempt
cov_1 <- fisher.test(
  events_filtered_1$att1_365,
  events_filtered_1$sex_demo
)
cov_2 <- chisq.test(
  events_filtered_1$att1_365,
  events_filtered_1$race_demo
)
cov_3 <- fisher.test(
  events_filtered_1$att1_365,
  events_filtered_1$latino_demo
)
cov_4 <- chisq.test(
  events_filtered_1$att1_365,
  events_filtered_1$degree_demo
)
cov_5 <- fisher.test(events_filtered_1$att1_365, events_filtered_1$prior_demo)
cov_6 <- chisq.test(events_filtered_1$att1_365, events_filtered_1$employ_demo)

report::report(cov_1)
report::report(cov_2)
report::report(cov_3)
report::report(cov_4)
report::report(cov_5)
report::report(cov_6)

cov_7 <- t.test(age_demo ~ att1_365, data = events_filtered_1)
report::report(cov_7)
```

# AIM 1

# Do people with recent behavior anticipate having suicidal behavior at higher rates?
```{r chi recent expect}
chi_1a <- chisq.test(
  events_filtered$q15_ssi_2, # Self-rated expectation (no/unsure vs. sure)
  events_filtered$attempt_recent # recent suicide attempt (presence vs. absence)
)

# Look at results
chi_1a

# Tidy results
report::report(chi_1a)

# Make sure chi-square is appropriate
chi_1a$expected

# Make table
sjPlot::tab_xtab(
  var.row = events_filtered$q15_ssi_2,
  var.col = events_filtered$attempt_recent,
  title = "Contingency Table",
  show.row.prc = TRUE,
  show.col.prc = TRUE,
  show.summary = TRUE,
  statistics = "pearson",
  show.exp = TRUE,
  show.legend = TRUE,
  file = paste0("02_Output/Contingency_full_recent_expect_", Sys.Date(), ".doc")
)
```

# Do people with method/opportunty anticipate having suicidal behavior at higher rates?
```{r chi access expect}
chi_2a <- chisq.test(
  events_filtered$q15_ssi_2, # Self-rated expectation (no/unsure vs. sure)
  events_filtered$q13_ssi_2
) # Perceived access to method/opportunity for suicide (no method and/or opportunity vs. yes)

# Look at results
chi_2a

# Tidy results
report::report(chi_2a)

# Make sure chi-square is appropriate
chi_2a$expected

# Make table
sjPlot::tab_xtab(
  var.row = events_filtered$q15_ssi_2,
  var.col = events_filtered$q13_ssi_2,
  title = "Contingency Table",
  show.row.prc = TRUE,
  show.col.prc = TRUE,
  show.summary = TRUE,
  statistics = "pearson",
  show.exp = TRUE,
  show.legend = TRUE,
  file = paste0("02_Output/Contingency_full_access_expect_", Sys.Date(), ".doc")
)
```

# Do people with preparation for suicide anticipate having suicidal behavior at higher rates?
```{r chi prep expect}
chi_3a <- chisq.test(
  events_filtered$q15_ssi_2, # Self-rated expectation (no/unsure vs. sure)
  events_filtered$q16_ssi_2 # preparation for suicide (no vs. some/completed-finished)
)

# Look at results
chi_3a

# Tidy results
report::report(chi_3a)

# Make sure chi-square is appropriate
chi_3a$expected

# Make table
sjPlot::tab_xtab(
  var.row = events_filtered$q15_ssi_2,
  var.col = events_filtered$q16_ssi_2,
  title = "Contingency Table",
  show.row.prc = TRUE,
  show.col.prc = TRUE,
  show.summary = TRUE,
  statistics = "pearson",
  show.exp = TRUE,
  show.legend = TRUE,
  file = paste0("02_Output/Contingency_full_prep_expect_", Sys.Date(), ".doc")
)
```


# Are people who anticipate suicidal behavior (vs unsure/no) more hopeless?
```{r t t chi hope expect}
# Full score
jmv::ttestIS(
  formula = bhs ~ q15_ssi_2,
  data = events_filtered,
  vars = vars(bhs),
  welchs = TRUE,
  mann = TRUE,
  norm = TRUE,
  eqv = TRUE,
  meanDiff = TRUE,
  effectSize = TRUE,
  desc = TRUE
)

wilcox.test(bhs ~ q15_ssi_2, data = events_filtered)

# positive-expectation
jmv::ttestIS(
  formula = bhs_pos ~ q15_ssi_2,
  data = events_filtered,
  vars = vars(bhs_pos),
  welchs = TRUE,
  mann = TRUE,
  norm = TRUE,
  eqv = TRUE,
  meanDiff = TRUE,
  effectSize = TRUE,
  desc = TRUE
)

wilcox.test(bhs_pos ~ q15_ssi_2, data = events_filtered)

# negative-expectation
jmv::ttestIS(
  formula = bhs_neg ~ q15_ssi_2,
  data = events_filtered,
  vars = vars(bhs_neg),
  welchs = TRUE,
  mann = TRUE,
  norm = TRUE,
  eqv = TRUE,
  meanDiff = TRUE,
  effectSize = TRUE,
  desc = TRUE
)

wilcox.test(bhs_neg ~ q15_ssi_2, data = events_filtered)
```

# Do people who anticipate suicidal behavior (vs unsure/no) also endorse less suicide-related coping?
```{r t t chi src expect}
jmv::ttestIS(
  formula = srcs17 ~ q15_ssi_2,
  data = events_filtered,
  vars = vars(srcs17),
  welchs = TRUE,
  mann = TRUE,
  norm = TRUE,
  eqv = TRUE,
  meanDiff = TRUE,
  effectSize = TRUE,
  desc = TRUE
)
```

# AIM 2

# Does expecting a suicide attempt predict future suicidal behavior?
```{r survival primary}
# Initial model
cox_1a <- coxph(
  Surv(
    surv_365, # Time-to-event, truncated at 365 days
    att1_365
  ) ~ # First suicidal behavior
    factor(arm_rec) + # Randomization condition
    factor(q15_ssi_2), # Self rated expectation of a future suicide attempt (no/unsure vs. yes)
  data = events_filtered
)
```

# Adjust for covariates
```{r survival covs}
# Recent suicidal behaviors (2a)
# Access to method/opportunity for suicide (3a)
# Preparation for suicide (4a)
# Hopelessness (global) (5a1)
# Positive expectations (5a2)
# Negative expectations (5a3)
# Perceived suicide-related coping (6a)

# Adjust for suicide behavior
cox_2a <- coxph(
  Surv(surv_365, att1_365) ~
    factor(arm_rec) + # Randomization condition
    factor(q15_ssi_2) + # Self rated expectation of a future suicide attempt (no/unsure vs. yes)
    (attempt_recent == 1), # Recent suicidal behavior (no vs yes)
  data = events_filtered
)

# Adjust for perceived access to method and opportunity for suicide
cox_3a <- coxph(
  Surv(surv_365, att1_365) ~
    factor(arm_rec) + # Randomization condition
    factor(q15_ssi_2) + # Self rated expectation of a future suicide attempt (no/unsure vs. yes)
    factor(q13_ssi_2), # Perceived access to method/opportunity for suicide (no access to method and/or opp. vs. yes)
  data = events_filtered
)

# Adjust for preparation for suicide
cox_4a <- coxph(
  Surv(surv_365, att1_365) ~
    factor(arm_rec) + # Randomization condition
    factor(q15_ssi_2) + # Self rated expectation of a future suicide attempt (no/unsure vs. yes)
    factor(q16_ssi_2), # Preparation (no vs. some or full prep)
  data = events_filtered
)

# Adjust for hopelessness (sum score)
cox_5a1 <- coxph(
  Surv(surv_365, att1_365) ~
    factor(arm_rec) + # Randomization condition
    factor(q15_ssi_2) + # Self rated expectation of a future suicide attempt (no/unsure vs. yes)
    bhs, # Hopelessness sum
  data = events_filtered
)

# Positive expectation hopelessness
cox_5a2 <- coxph(
  Surv(surv_365, att1_365) ~
    factor(arm_rec) + # Randomization condition
    factor(q15_ssi_2) + # Self rated expectation of a future suicide attempt (no/unsure vs. yes)
    bhs_pos, # Positive-expectation hopelessness (all positive expectation items summed)
  data = events_filtered
)

# Negative expectation hopelessness
cox_5a3 <- coxph(
  Surv(surv_365, att1_365) ~
    factor(arm_rec) + # Randomization condition
    factor(q15_ssi_2) + # Self rated expectation of a future suicide attempt (no/unsure vs. yes)
    bhs_neg, # Negative-expectation hopelessness (all negative expectation items summed)
  data = events_filtered
)

# Adjust for perceived suicide-related coping
cox_6a <- coxph(
  Surv(surv_365, att1_365) ~
    factor(arm_rec) + # Randomization condition
    factor(q15_ssi_2) + # Self rated expectation of a future suicide attempt (no/unsure vs. yes)
    srcs17, # Sucide Related Coping Scale sum score
  data = events_filtered
)

# kitchen sink model
cox_7a <- coxph(
  Surv(
    surv_365, # Time-to-event, truncated at 365 days
    att1_365
  ) ~ # First suicidal behavior
    factor(arm_rec) + # Randomization condition
    factor(q15_ssi_2) + # Self rated expectation of a future suicide attempt (no/unsure vs. yes)
    srcs17 + # Sucide Related Coping Scale sum score
    bhs + # hopelessness sum
    factor(q16_ssi_2) + # Preparation (no vs. some or full prep)
    factor(q13_ssi_2) + # Perceived access to method/opportunity for suicide (no access to method and/or opp. vs. yes)
    (attempt_recent == 1) + # Recent suicidal behavior (no vs yes)
    factor(cssrs_actattrec_bl) + # actual attempt lifetime
    bdi,
  data = events_filtered
)
summary(cox_7a)

# Main
summary(cox_1a)

# Adjusting for past-year suicidal behavior
summary(cox_2a)

# Adjusting for perceived access
summary(cox_3a)

# Adjusting for preparation
summary(cox_4a)

# Adjusting for hopelessness
summary(cox_5a1) # Sum score
summary(cox_5a2) # Positive sum score
summary(cox_5a3) # Negative sum score

# Adjusting for percieved suicide-related coping
summary(cox_6a)


# Test for improvements from the initial model with the covariates
anova(cox_1a, cox_2a) # Initial vs. recent suicidal behavior
anova(cox_1a, cox_3a) # Initial vs. perceived access to method & oppurtunity for suicide
anova(cox_1a, cox_4a) # Initial vs. preparation for suicide
anova(cox_1a, cox_5a1) # Inital vs. hopelessness (sum score)
anova(cox_1a, cox_5a2) # Initial vs. positive expectations
anova(cox_1a, cox_5a3) # Initial vs. negative expectations
anova(cox_1a, cox_6a) # Initial vs. perceived suicide-related coping

# Check the proportional hazards assumption for all models
cox.zph(cox_1a)
cox.zph(cox_2a)
cox.zph(cox_3a)
cox.zph(cox_4a)
cox.zph(cox_5a1)
cox.zph(cox_5a2)
cox.zph(cox_5a3)
cox.zph(cox_6a)

# Summed hopelessness in model 5a1 violated the proportional hazards assumption
# Summed positive expectations in model 5a2 violated the proportional hazards assumption

# Re-fit the models with an hopelessness x time interaction
cox_5b1 <- coxph(
  Surv(surv_365, att1_365) ~
    factor(arm_rec) + # Randomization condition
    factor(q15_ssi_2) + # Self rated expectation of a future suicide attempt (no/unsure vs. yes)
    bhs + # hopelessness sum
    tt(bhs), # hopelessness x time
  data = events_filtered,
  tt = function(x, t, ...) x * t # Define the time function
)

cox_5b2 <- coxph(
  Surv(surv_365, att1_365) ~
    factor(arm_rec) + # Randomization condition
    factor(q15_ssi_2) + # Self rated expectation of a future suicide attempt (no/unsure vs. yes)
    bhs_pos + # positive expectations sum
    tt(bhs_pos), # positive expectations x time
  data = events_filtered,
  tt = function(x, t, ...) x * t # Define the time function
)

# Hopelessness x time
summary(cox_5b1)

# Positive expectations x time
summary(cox_5b2)
```

# Survival curve figure
```{r survival fig }
# Make a labeled self-rated expectation variable
events_filtered <- events_filtered %>%
  mutate(q15_ssi_label = factor(q15_ssi_2,
    levels = c(0, 1),
    labels = c("No/Unsure", "Yes")
  ))

# Survival curve with just self-rated expectation (labeled)
cox_1a_fit <- survfit(
  Surv(surv_365, att1_365) ~
    q15_ssi_label,
  data = events_filtered
)

# Make + save the figure
tiff(paste0("02_Output/Survival_plot_", format(Sys.Date(), "%Y-%m-%d"), ".tiff"),
  units = "in", width = 8, height = 5, res = 300
)

curves <- autoplot(
  cox_1a_fit,
  conf.int = FALSE,
  censor.shape = "*",
  censor.size = 5,
  surv.size = 1.1,
  facets = TRUE,
  ncol = 2
) +
  labs(
    x = "Time to suicide attempt",
    y = "Survival",
    color = "Expectation of a future suicide attempt"
  ) +
  coord_cartesian(ylim = c(0.25, 1)) +
  theme_minimal(base_size = 14, base_family = "Times New Roman") +
  theme(
    panel.grid.major = element_line(color = "grey90"),
    panel.grid.minor = element_line(color = "grey95"),
    panel.background = element_rect(fill = "white"),
    strip.background = element_rect(fill = "white"),
    legend.position = "bottom"
  )

dev.off()

curves
```


